$(function() {
  if ($('body.show').length === 0 )
    return;

  var activeKnob, knob;
  var display = new Display($('#led'));
  var limit = 140;

  // TODO DRY this up
  var midiMultiples = {
    0: 'C',
    1: 'C#',
    2: 'D',
    3: 'D#',
    4: 'E',
    5: 'F',
    6: 'F#',
    7: 'G',
    8: 'G#',
    9: 'A',
    10: 'A#',
    11: 'B',
  };

  var midiNoteNumbers = {};
  for (i = 0; i < 128; i++) {
    midiNoteNumbers[i] = midiMultiples[i % 12] + Math.floor(i / 12);
  }

  var midiOut = new MidiOut;

  $('#midi-device').change(function(){
    midiOut.changeOutput(this);
    midiOut.enableSync();
  });

  $('#midi-channel').change(function(){
    midiOut.changeChannel(this);
    midiOut.enableSync();
  });

  $('#sync').click(function(){
    $('.knob').each(function(){
      if (midiOut.ready()) {
          midiOut.output.sendControlChange(
            $(this).data('control-number'),
            $(this).data('midi'),
            midiOut.channel
          )
      }
    });
  });

  $('.knob').each(function() {
    my_knob = new Knob(this);
    degree = my_knob.degreeForMidi($(this).data('midi'), limit);
    $(this).data('rotation', degree);
    my_knob.autoRotate(degree, '#' + $(this).attr('id'));
  });

  $('.bottom-row label').each(function(){
    if ($(this).find('span').find('div').data('active')) {
      $(this).find('span').find('div').addClass('lit');
    }
  });

  $('.sequence-light').each(function(){
    if ($(this).data('active')) {
      $(this).addClass('lit');
    }
  });

  $('.step-note').each(function(){
    $(this).html(midiNoteNumbers[parseInt($(this).data('note'))]);
  });

  $('.button').each(function(){
    var vco, value, vcoKnob, input;
    vco = $(this).attr('id').split('_')[0];
    value = $(this).data('active');
    vcoKnob = $('.knob#' + vco + '_pitch');
    if (value === true) {
      $(this).addClass('lit');
      vcoKnob.addClass('lit');
    }
  });

  $('.knob').mouseenter(function(){
    var midi = $(this).data('midi');
    activeKnob = new Knob(this);
    display.update(midi, activeKnob.isPitch, activeKnob.isOctave);
  });
});
